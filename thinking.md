# Размышления над задачей

## Знакомство с таблицей user

Размеры: 3910×4, поля (uid, source, region, cost).

uid:
  Возрастающее целое число от 1 до кол-ва пользователей, первичный ключ.

source:
  Видимо, источник привлечения пользователя. Принимает одно из значений: 
  (cpc_adwords, cpc_direct, seo, smm). Стоимость разных источников мало
  отличается, боксплоты и вайолины очень похожи.  Есть отличия по регионам.

  ```
  > ggplot(user, aes(source, cost)) + geom_boxplot()
  > ggplot(user, aes(source, cost)) + geom_violin()
  ```

 Количество пользователей, привлечённых разными способами:
 
 | Способ привлечения | Цена |
 |:-------------------|-----:|
 | cpc_adwords        | 958  |
 | cpc_direct         | 922  |
 | seo                | 1016 |
 | smm                | 1014 |

region:
  Регион пользователя. Есть 6 регионов, количество пользователей в них близко:

  | регион            | #users |
  |:------------------|-------:|
  | ekb               |  609   |
  | moscow            |  645   |
  | orel              |  687   |
  | spb               |  664   |
  | vladimir          |  619   |
  | volgograd         |  686   |

cost:
  По всей видимости, стоимость привлечения пользователя. В среднем стоимость привлечения незначительно
  изменяется от региона к региону, но есть заметные отличия по способам привлечения.  Медианная стоимость
  привлечения пользователя в разрезе способов привлечения и регионов:

|region       |  cpc_adwords |  cpc_direct | seo   | smm
|:------------|:-------------|:------------|:------|:--------------
|       ekb   |   343.5      |   354       | 365   | 358
|    moscow   |   359        |   350       | 366   | 337.5
|      orel   |   359.5      |   346.5     | 310.5 | 345
|       spb   |   356.5      |   349       | 339   | 370
|  vladimir   |   358        |   372       | 332   | 358
| volgograd   |   340        |   341       | 347.5 | 353


## Знакомство с таблицей log

Размыры: 35775×4, поля (uid, date, event_type, sum), где uid ссылка на идентификатор пользователя,
date в формате YYYY-MM-DD, event_type может быть "(visit|purchase)" и sum либо сумма покупки, либо NA.

Первичного ключа в таблице нет.

Диапазон дат: 1 января — 5 марта 2014

```
R> summary(log$date)
        Min.      1st Qu.       Median         Mean      3rd Qu.         Max. 
"2014-01-01" "2014-01-21" "2014-02-05" "2014-02-03" "2014-02-19" "2014-03-05" 
```

Даты в логе не отсортированы (довольно странно для лога :) )

Проверяю, нужна ли мне вообще колонка 'event_type'

```
dgolub=> select * from prj1.log where event_type='visit' and sum is not null;
 uid | date | event_type | sum 
-----+------+------------+-----
(0 rows)
```

Понятно, таких нет.  А покупка без суммы?

```
dgolub=> select * from prj1.log where event_type='purchase' and sum is null;
 uid | date | event_type | sum 
-----+------+------------+-----
(0 rows)
```

ОК, при визите не покупаем, при покупке всегда платим. Можно event type не держать в таблице.

Юнит-экономику можно считать по месяцам или по неделям, для этого есть смысл завести отдельные
колонки в базе данных с номером месяца и номером недели.

## Первый визит пользователя

Для когортных расчётов нужно знать, когда пользователь пришёл первый раз, это можно сделать, найдя минимальную
дату его визита.

```{sql}
select u.uid, min(l.date)
  from prj1.user as u
  left join prj1.log as l
  on u.uid=l.uid group by u.uid 
  order by u.uid ;
```

Забавно, что для некоторых пользвателей визитов и покупок нет вообще.  Мы их привлекли, этим всё и ограничилось.

Для когортного анализа полезны номера месяцев и недель. Можно нарезать эти промежутки с помощью функций date_trunc (то есть привести к первой дате интервала) или преобразовать в номер месяца (недели).  Нужную информацию можно внести прямо в таблицу `log`.
